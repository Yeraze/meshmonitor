# TODOs

## In Progress
None

## Technical Debt / Known Issues
- Auto-welcome settings validation improvements
  - [ ] Add validation for autoWelcomeTarget (similar to autoAckChannels)
    - Validate channel index is within 0-7 range
    - Return 400 error for invalid values
    - Location: src/server/server.ts POST /api/settings endpoint
  - [ ] Add message length validation for autoWelcomeMessage
    - Currently no length restrictions (unlike autoAckRegex limited to 100 chars)
    - Consider max length to prevent database/UI issues
    - Location: src/server/server.ts POST /api/settings endpoint
  - [ ] Add test coverage for /api/settings POST endpoint
    - No server-side tests found for settings persistence
    - Should test auto-welcome settings validation
    - Should test settings save/load cycle
    - Location: tests/ directory (create new test file)

## Completed
- Node lastHeard timestamp fix
  - [x] Identified issue: processNodeInfoProtobuf and processNodeInfo were using server time instead of node's lastHeard from protobuf
  - [x] Root cause: All nodes got same timestamp when nodelist was downloaded, not reflecting when each node was actually last heard
  - [x] Fixed processNodeInfoProtobuf (line 1863) to use nodeInfo.lastHeard from protobuf with fallback to server time
  - [x] Fixed legacy processNodeInfo function (line 3111) to use nodeInfo.lastHeard with fallback to server time
  - [x] Added Math.min() cap to prevent future timestamps from being stored (handles nodes with incorrect time)
  - [x] Built and deployed fix to Docker container
  - Impact: Each node now shows its actual last heard time, not the time of the last nodelist download, with protection against future timestamps
- Traceroute utility refactoring
  - [x] Fixed array mutation bug in traceroute.tsx using immutable Set-based tracking instead of splice()
  - [x] Fixed SNR index calculation to use correct indices from unmutated arrays
  - [x] Fixed distance calculation to use correct indices from unmutated arrays
  - [x] Consolidated formatTracerouteRoute implementations - removed duplicate from App.tsx
  - [x] Created baseline tests for formatNodeName utility (6 tests)
  - [x] All 898 tests passing with no regressions
  - Impact: Accurate SNR values and distance calculations in traceroute displays, eliminated code duplication
- Telemetry Dashboard Local Storage persistence
  - [x] Add Local Storage save functionality when drag-and-drop reordering
  - [x] Add Local Storage load functionality on component mount with localStorage priority
  - [x] Implement smart merge logic (localStorage takes priority over server settings)
  - [x] Ensure persistence across browser sessions and page reloads
  - Impact: Custom telemetry dashboard layout now persists across sessions
- Traceroute display and interaction improvements (PR #328)
  - [x] Fix traceroute path direction display (multiple iterations to correct forward/return path mapping)
  - [x] Add RouteSegmentTraceroutesModal to view all traceroutes using a specific route segment
  - [x] Make node names clickable in route segment popup to select and center on map
  - [x] Skip rendering traceroute when selecting local/current node
  - [x] Improve node name display format to "Longname [Shortname]" when different
  - [x] Add immediate polling after traceroute requests (2s, 5s, 10s, 15s) for better UI responsiveness
  - [x] Fix Messages page to show traceroutes in both directions
  - [x] Add "Show failed traceroutes" checkbox filter to TracerouteHistoryModal
  - [x] Correctly distinguish between null (failed), [] (0-hop direct), and [hops] (intermediate nodes)
  - [x] Consolidate formatTracerouteRoute into shared utility to prevent future parameter order mistakes
  - [x] Fix all traceroute endpoint direction displays across Messages page, TracerouteHistoryModal, RouteSegmentTraceroutesModal, and map popups/segments
  - Impact: Much better traceroute visualization and interaction
- Telemetry Dashboard enhancements (PR #314)
  - [x] Add filter functionality to search nodes by name or ID
  - [x] Add sort functionality (by name, ID, battery, voltage, last update)
  - [x] Implement drag-and-drop to reorder telemetry cards
  - [x] Save card order to local storage for persistence
  - [x] Add visual indicators for active filters and sort states
  - Impact: Much better UX for users managing many nodes
- Session rolling timeout fix (PR #315)
  - [x] Add SESSION_ROLLING environment variable (default: true)
  - [x] Enable rolling sessions to reset expiry on each request
  - [x] Add logging for SESSION_MAX_AGE and rolling setting
  - [x] Update documentation in README.md, docs/, and .env.example
  - Impact: Fixed premature logouts for users with multi-day SESSION_MAX_AGE settings
- Configuration persistence after device reboot (FINAL FIX v2)
  - [x] Identified issue: getDeviceConfig() returns cached data instead of requesting fresh config
  - [x] Fixed RebootModal to call refreshNodes() instead of getDeviceConfig()
  - [x] Fixed ImportConfigModal to use same pattern (connection status check + refreshNodes)
  - [x] refreshNodes() sends want_config_id to device to trigger fresh config transmission
  - [x] Identified second issue: ConfigurationTab not refreshing after reboot modal closes
  - [x] Added refreshTrigger prop to ConfigurationTab to force config reload
  - [x] App.tsx increments refreshTrigger when reboot modal closes
  - [x] ConfigurationTab re-fetches config when refreshTrigger changes
  - [x] Identified third issue: Browser HTTP cache preventing fresh config fetch
  - [x] Added timestamp cache-busting parameter to getCurrentConfig() API call
  - [x] Build and deploy successfully
- Configuration page reboot detection - fixed-time approach (FINAL v2)
  - [x] Identified massive rate limiting issue from polling loops
  - [x] Replaced complex two-phase polling with simple fixed-time approach
  - [x] Modal now waits 30 seconds for device to reboot (typical reboot time)
  - [x] After 30s, verifies connection with up to 3 retry attempts (3s apart)
  - [x] Requests fresh device configuration after verification
  - [x] Avoids all rate limiting issues by eliminating polling loops
  - [x] Build and deploy successfully
- RebootModal minimum wait time
  - [x] Added 10-second minimum wait when device doesn't disconnect
  - [x] Ensures device has time to fully reboot before verifying
  - [x] Prevents modal from closing too quickly on fast reboots
  - [x] Build and deploy successfully
- RebootModal async loop cancellation fix
  - [x] Identified exponential doubling of /api/connection requests (10+ req/sec)
  - [x] Root cause: useEffect re-running when isOpen changes, creating multiple async polling loops
  - [x] Added isCancelled flag to abort ongoing async loops when component unmounts
  - [x] Added cancellation checks in both while loops (!isCancelled condition)
  - [x] Set isCancelled=true in cleanup function to stop orphaned loops
  - [x] Build and deploy successfully
  - Problem: Each time modal opened/closed, a new pollForReconnection() started while old ones kept running
  - Solution: Cancellation token pattern to abort async loops on cleanup
- Configuration page reboot detection - rate limiting fix (FINAL)
  - [x] Identify source of excessive /api/connection polling (App.tsx + RebootModal both polling every 5s)
  - [x] Pause App.tsx connection polling when RebootModal is active
  - [x] Fix interval multiplication bug (removing showRebootModal from useEffect deps)
  - [x] Fix closure stale state issue using ref pattern (showRebootModalRef)
  - [x] Add useEffect to keep ref in sync with state changes
  - [x] Update interval to use ref instead of state variable
  - [x] Build and deploy successfully
  - Root causes:
    1. Including showRebootModal in useEffect dependency array caused interval to recreate every time modal opened/closed
    2. React closure captured stale value of showRebootModal when interval was created, so state changes weren't reflected
  - Solution: Use ref pattern (showRebootModalRef) to access current value without triggering useEffect re-runs
- Configuration page reboot detection and verification
  - [x] Create RebootModal component with device reconnection polling
  - [x] Add animated progress indicator showing reboot status
  - [x] Implement two-phase reboot detection: wait for disconnect, then reconnect
  - [x] Phase 1: Monitor connection status until device disconnects
  - [x] Phase 2: Monitor connection status until device reconnects (60s timeout)
  - [x] Request fresh device configuration after reconnect using getDeviceConfig()
  - [x] Add status messages: "Waiting for device to disconnect...", "Device disconnected. Waiting for reboot...", "Device reconnected! Requesting fresh configuration...", "Waiting for device configuration...", "Configuration verified!"
  - [x] Reduce polling interval to 5 seconds to avoid rate limiting
  - [x] Add rate limit detection and exponential backoff (10s wait on 429 errors)
  - [x] Update App.tsx to show RebootModal when configuration changes trigger reboot
  - [x] Refresh nodes and channels data after successful reboot
  - [x] Hook into existing onConfigChangeTriggeringReboot callback from ConfigurationTab
  - [x] Applies to all configuration saves that require reboot: Device Config, LoRa Config, Position Config, MQTT Config, NeighborInfo Config
  - [x] Build and deploy successfully
- Channel import progress tracking and device reboot detection
  - [x] Reorder import operations: send all channels first, then LoRa config (to avoid premature reboot)
  - [x] Add requiresReboot flag to import API response
  - [x] Update ImportConfigModal with "Import in Progress" status display
  - [x] Add animated progress indicator during import
  - [x] Implement device reconnection detection after reboot (60s timeout)
  - [x] Implement channel update polling after import (30s timeout)
  - [x] Prevent modal dismissal during import progress
  - [x] Show real-time status messages: "Sending configuration", "Device rebooting...", "Verifying configuration"
  - [x] Update API service interface to handle requiresReboot flag
  - [x] Build and deploy successfully
- Channel edit/import device synchronization
  - [x] Add setChannelConfig calls to PUT /api/channels/:id endpoint
  - [x] Add setChannelConfig calls to POST /api/channels/:slotId/import endpoint
  - [x] Ensure channel edits from UI are sent to Meshtastic device
  - [x] Ensure JSON channel imports are sent to Meshtastic device
  - [x] Build and deploy successfully
- Channel URL import functionality
  - [x] Add role field to DecodedChannelSettings interface
  - [x] Implement channel import API backend endpoint (POST /api/channels/import-config)
  - [x] Add setChannelConfig method to meshtasticManager
  - [x] Add createSetChannelMessage method to protobufService
  - [x] Add importConfig method to frontend API service
  - [x] Update ImportConfigModal to call import API
  - [x] Build and deploy successfully
- Device configuration endpoint improvements
  - [x] Add explicit LoRa config request on device connection
  - [x] Add diagnostic logging for config reception tracking
  - [x] Fix 503 errors on /api/device-config endpoint
  - [x] Ensure actualDeviceConfig.lora is populated for Configuration tab
- Channel role and position precision fields
  - [x] Add role and positionPrecision to Channel type definitions
  - [x] Create database migration 012 to add new columns to channels table
  - [x] Update database upsertChannel method to handle new fields
  - [x] Update backend API endpoints (PUT, POST import, GET export) with validation
  - [x] Update frontend API service methods with new field types
  - [x] Add Channel Role selector (Disabled/Primary/Secondary) to edit modal
  - [x] Add Location Precision input (0-32 bits) to edit modal
  - [x] Fix checkbox alignment in edit modal
  - [x] Update processChannelProtobuf to sync role and positionPrecision from Meshtastic device
  - [x] Remove default value setting - now syncs from device
  - [x] Build and deploy successfully
- Channel configuration management on Configuration tab
  - [x] Review Meshtastic protobuf definitions and existing code structure
  - [x] Add backend API endpoints (PUT /api/channels/:id, GET /api/channels/:id/export, POST /api/channels/:slotId/import)
  - [x] Update frontend API service with channel operations methods
  - [x] Create ChannelsConfigSection component with channel list display
  - [x] Implement channel export functionality (download JSON)
  - [x] Implement channel edit modal with form validation
  - [x] Implement channel import functionality (upload JSON)
  - [x] Add ChannelsConfigSection to ConfigurationTab
  - [x] Build and deploy Docker container successfully
- Auto Acknowledge channel selection test coverage
  - [x] Create comprehensive AutoAcknowledgeSection component tests (63 tests covering rendering, channel checkboxes, state management, saving, validation, pattern testing, and edge cases)
  - [x] Create comprehensive AutoAnnounceSection component tests (47 tests covering rendering, token substitution preview, token insertion buttons, channel selection, interval configuration, announce on start, state management, saving, and Send Now functionality)
  - [x] Create backend channel filtering tests for meshtasticManager (28 tests covering channel parsing, filtering logic, edge cases, integration scenarios, regex caching, and default values)
  - [x] Verify all tests pass in full test suite (788 tests passed)
  - Note: Component tests are skipped due to jsdom compatibility issues (same as existing Toast.test.tsx), but backend tests run successfully
- Auto Acknowledge UI/UX improvements
  - [x] Rearrange Auto Acknowledge Pattern Testing area with textarea and results side-by-side on desktop
  - [x] Reduce vertical spacing of red/green bubble entries for better alignment
  - [x] Add Sample Message Preview to Auto Announce section showing token substitution
  - [x] Add channel-specific auto-acknowledge checkboxes to control which channels trigger auto-ack
  - [x] Add Direct Messages checkbox for auto-acknowledge on DMs
  - [x] Update backend to support channel-specific auto-ack settings (autoAckChannels, autoAckDirectMessages)
  - [x] Update frontend AutoAcknowledgeSection component with channel checkboxes
  - [x] Update UIContext and App.tsx to manage new state variables
  - [x] Update system tests to use dev container node IP (192.168.4.217)
  - [x] Configure vitest to run tests serially to prevent OOM issues
- Version 2.9.1 - Add Support MeshMonitor button to Settings page
  - [x] Add prominent "Support MeshMonitor" button with Ko-fi link to Settings header
  - [x] Style button as blue square with heart emoji and text
  - [x] Add hover effect for better UX
- Version 2.9.0 - Mesh Traffic Monitor & UI Improvements
- Created GitHub release v2.9.0
- Implement mesh packet monitor feature (issue #285)
  - [x] Add packet_log database table and configuration settings
  - [x] Create PacketLogService for logging and cleanup
  - [x] Hook packet logging into processMeshPacket
  - [x] Create API routes for packet operations (/api/packets)
  - [x] Create frontend components (PacketMonitorPanel, PacketTable, etc.)
  - [x] Add packet monitor settings section to Settings tab
  - [x] Modify NodesTab to include packet monitor panel with split view
  - [x] Add responsive CSS to hide packet monitor on mobile
  - [x] Fix settings persistence bug (hasChanges tracking)
  - [x] Fix permission middleware (add optionalAuth() to packet routes)
  - [x] Fix settings save bug (add packet monitor settings to validKeys whitelist)
  - [x] Hide "Show Packet Monitor" checkbox when packet logging is disabled
  - [x] Make To/From node IDs clickable to select and center on nodes
  - [x] Test packet logging with encryption and permissions
- Fix update notification banner dismiss button overflow (issue #269)
- Implement reply button auto-focus feature (issue #280)
  - Added auto-focus to message input when clicking reply button
  - Added reply state clearing when switching channels or DM nodes
- Version 2.8.8
- Fix TRUST_PROXY environment variable to support all Express values (true/false/number/IP)
- Created GitHub release v2.8.8
- Version 2.8.9
- Reverted mobile node popup dimension changes from PR #279
- Created GitHub release v2.8.9
- Add paho-mqtt<2.0 dependency for Apprise MQTT support (issue #276, PR #287)
- Packet monitor enhancements (issue #285 continued)
  - [x] Fix packet detail modal background transparency (increased opacity and z-index)
  - [x] Move packet monitor to bottom of screen instead of right side
  - [x] Show telemetry type in Content column (Device, Environment, Power, etc.)
  - [x] Improve Position packet content to show coordinates in degrees
  - [x] Improve NodeInfo packet content to show node name
  - [x] Enhance modal popup styling (stronger shadow, larger border, higher z-index)
  - [x] Fix map tile loading issue when packet monitor is toggled (added MapResizeHandler)
  - [x] Add blue border and glow effect to packet detail modal for better visibility
  - [x] Fix packet detail modal dark mode colors to use --ctp-surface0 background
  - [x] Import full list of port numbers from official Meshtastic protobuf definitions
  - [x] Add color coding for 15+ packet types in PacketMonitorPanel
  - [x] Remove page footer (duplicate info in sidebar)
  - [x] Fix filter dropdown white background for dark mode readability
- Packet monitor API improvements (PR #289 feedback)
  - [x] Add max limit validation (1000) to prevent unbounded queries
  - [x] Add input validation for offset and limit parameters
  - [x] Reduce polling interval from 2s to 5s (60% reduction in API calls)
  - [x] Reduce traceroute polling from 10s to 60s (83% reduction)
  - [x] Reduce neighbor info polling from 10s to 60s (83% reduction)
- Packet logging test coverage
  - [x] Create comprehensive test suite for packetLogService (23 tests covering configuration, logging, filtering, counting, retrieval, cleanup, and state management)
  - [x] Create integration tests for packet API routes (16 tests covering GET /api/packets with filters, GET /api/packets/stats, GET /api/packets/:id, DELETE /api/packets with permission checks)
- API consolidation performance improvement (PR #313)
  - [x] Create backend /api/poll endpoint that consolidates all frequently-polled data
  - [x] Update frontend App.tsx to use /api/poll instead of individual endpoints
  - [x] Write comprehensive tests for /api/poll endpoint (21 API contract tests)
  - [x] Review and update existing endpoint tests for redundancy
  - [x] Update API documentation for new polling endpoint
  - [x] Test the consolidated polling in Docker environment
  - [x] Create PR for API consolidation performance improvement
  - Impact: Reduced API requests from 96/minute to 12/minute (88% reduction), eliminating rate limit 429 errors